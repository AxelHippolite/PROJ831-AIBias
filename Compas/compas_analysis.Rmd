---
title: "compas_analysis"
author: "Rami Boughanmi & MaÃ«l RIBES"
date: "2023-03-24"
output: html_document:
  number_sections: TRUE
---

# Compas Dataset Analysis

------------------------------------------------------------------------

## Library imports

```{r}

library(CGPfunctions)
library(treemap)
library(ggplot2)
```

## Dataset cleaning

We saw that each row in the original dataset was duplicated for each type of assessment. We have therefore separated the dataset into 3 dataframes corresponding to each of the categories.

```{r}
# Import CSV
compas_all_data <- read.csv("compas-scores-raw.csv")

# Cleaning ethnic codes 
compas_all_data$Ethnic_Code_Text <- sub("African-American", "Afro-Am", compas_all_data$Ethnic_Code_Text)
compas_all_data$Ethnic_Code_Text <- sub("African-Am", "Afro-Am", compas_all_data$Ethnic_Code_Text)
compas_all_data$Ethnic_Code_Text <- sub("Native American", "Native-Am", compas_all_data$Ethnic_Code_Text)

# Calculation of defendants' age and addition of the "age" column to compas_data
compas_all_data$DateOfBirth <- as.POSIXct(paste0(substr(compas_all_data$DateOfBirth,1,6),"19",substr(compas_all_data$DateOfBirth,7,8)), format = "%m/%d/%Y")
compas_all_data$Age <- as.integer(difftime(Sys.time(), compas_all_data$DateOfBirth, units = "days")/365.25)

# Separation of datasets 
RK_recidivism <- subset(compas_all_data, DisplayText == "Risk of Recidivism")
RK_violence <- subset(compas_all_data, DisplayText == "Risk of Violence")
RK_failure_appear <- subset(compas_all_data, DisplayText == "Risk of Failure to Appear")

```

## Risk of violence analysis

As a first step, we chose to study the risk of violence dataset. Let's look at the number of defendants and the distribution of age, sexes, ethnicity etc.

### Ethnicity analysis

```{r}
# Calculation of the number of defendants
nb_defendants <- nrow(RK_violence)

# Extraction of all ethnic groups and their number of individuals
all_ethnicity <- unique(RK_violence$Ethnic_Code_Text)
all_ethnicity_count <- data.frame(ethnicity = character(), count = numeric())
RK_violence_ethnicity <-  subset(RK_violence, select = c(Ethnic_Code_Text, ScoreText)) 

for (ethnicity in all_ethnicity){
  count <- nrow(subset(RK_violence, Ethnic_Code_Text == ethnicity))
  all_ethnicity_count <- rbind(all_ethnicity_count, data.frame(ethnicity = ethnicity, count = count))
}

# Console display of the distribution of different races
print(paste("Total number of defendants :", nb_defendants))
for (ethnicity in all_ethnicity){
  print(paste("distribution of",ethnicity, ":", round((nrow(subset(RK_violence_ethnicity, Ethnic_Code_Text == ethnicity))/nb_defendants)*100,3),"%"))
}

print(all_ethnicity_count)

treemap(all_ethnicity_count, 
        index = "ethnicity", 
        vSize = "count", 
        type = "index",
        title = "Ethnicity count",
        title.legend = "Ethnicity",
        )

PlotXTabs2(
  data = RK_violence_ethnicity,
  y = ScoreText,
  x = Ethnic_Code_Text,
  plottype = "side",
  xlab = "Ethnicity",
  ylab = NULL,
  label.text.size = 2,
  results.subtitle = FALSE,
  sample.size.label = FALSE,
  data.label = "counts",
  legend.title = "Risk of violence",
  legend.position = "right",
  title = "Risk of violence by ethnicity",
  palette = "Set1"
)

PlotXTabs2(
  data = RK_violence_ethnicity,
  y = ScoreText,
  x = Ethnic_Code_Text,
  xlab = "Ethnicity",
  ylab = NULL,
  results.subtitle = FALSE,
  legend.title = "Risk of violence",
  legend.position = "right",
  title = "Risk of violence by ethnicity",
  palette = "Set1"
)

```

We find in the dataset a total number of 20281 defendants. The majority of defendants belong to the ethnic groups of African Americans (44.406%) and Caucasians (35.802%). The other ethnic groups represent a much smaller proportion. If we take a look at the distribution of each individual's presumed violence risk score by ethnicity, we can see some very interesting information. The violence risk score is a number between 0 and 10 but on the graphs presented above, we use 3 categories: low (0-4), medium (5-7) and high (8-10). The first graph shows us visually that the African American and Caucasian ethnic groups are the most represented. However, this visualization is not relevant to draw conclusions about the score so we made the second graph. On this one we no longer plot the number of individuals in ordinal but we plot the percentage of individuals in each score category for each ethnicity. We see that the "Low" category is the most represented regardless of ethnic group. However, the African American and Native American categories have a higher proportion of Medium and High risk individuals than the other categories. We will try to explain these results later .

### Ages analysis

```{r}

all_ages = unique(RK_violence$Age)

# Console display of the distribution of different ages
for (age in all_ages){
  print(paste("Distribution of people who are ", age, "years old :", round((nrow(subset(RK_violence, Age == age))/nb_defendants)*100, 3),"%"))
}

# Create a vector with the number of defendants per age
def_by_age <- sapply(all_ages, function(age) nrow(subset(RK_violence, Age == age)))

# Display a bar chart for the distribution of ages
barplot(def_by_age, names.arg = all_ages, xlab = "Age", ylab = "Number of defendants", main = "Distribution of defendants' ages")

# Create a data frame with the distribution of ages
age_distribution <- data.frame(age = all_ages, percentage = sapply(all_ages, function(x) {nrow(subset(RK_violence, Age == x))/nb_defendants}))

# Creation of a dataframe with age groups
age_groups <- c(0, 25, 30, 40, 50, 60, Inf)

RK_violence_age$AgeGroup <- cut(RK_violence_age$Age, age_groups, labels = c("<25", "25-30", "30-40", "40-50", "50-60", ">60"))


# Create a histogram of age distribution
ggplot(age_distribution, aes(x=age, y=percentage)) + 
  geom_bar(stat="identity") +
  labs(title="Age distribution of the defendants", x="Age", y="Pourcentage") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))

PlotXTabs2(
  data = RK_violence_age,
  y = ScoreText,
  x = AgeGroup,
  plottype = "side",
  xlab = "Ethnicity",
  ylab = NULL,
  label.text.size = 2,
  results.subtitle = FALSE,
  sample.size.label = FALSE,
  data.label = "counts",
  legend.title = "Risk of violence",
  legend.position = "right",
  title = "Risk of violence by AgeGroup",
  palette = "Set1"
)

PlotXTabs2(
  data = RK_violence_age,
  y = ScoreText,
  x = AgeGroup,
  xlab = "Ethnicity",
  ylab = NULL,
  results.subtitle = FALSE,
  legend.title = "Risk of violence",
  legend.position = "right",
  title = "Risk of violence by AgeGroup",
  palette = "Set1"
)

```

We observe that there is still a fairly uniform distribution among the different age groups, however, we still have a concentration of defendants in the age group of 30-40 years. One thing is particularly obvious when looking at the violence risk score: the younger the chosen age category, the greater the proportion of high-risk individuals in this category. In particular, more than 80% of individuals under the age of 30 are individuals presumed to be at risk.

### Sexes analysis

```{r}

all_sexes = unique(RK_violence$Sex_Code_Text)

# Console display of the distribution of different sexes
for (sex in all_sexes){
  print(paste("Distribution of",sex,":", round((nrow(subset(RK_violence, Sex_Code_Text == sex))/nb_defendants)*100, 3),"%"))
}

# Create a data frame with the sex distribution
sex_distribution <- data.frame(sex = all_sexes, percentage = sapply(all_sexes, function(x) {nrow(subset(RK_violence, Sex_Code_Text == x))/nb_defendants}))

# Pie chart of sex distribution
ggplot(sex_distribution, aes(x = "", y = percentage, fill = sex)) + 
  geom_bar(stat = "identity", width = 1) +
  coord_polar("y", start = 0) +
  labs(title = "Sex distribution in the dataset")+ 
  theme_void() +
  geom_text(aes(label = paste0(round(percentage*100), "%")), position = position_stack(vjust = 0.5)) +
  scale_fill_brewer(palette="Set1")

PlotXTabs2(
  data = RK_violence,
  y = ScoreText,
  x = Sex_Code_Text,
  plottype = "side",
  xlab = "Sex",
  ylab = NULL,
  label.text.size = 2,
  results.subtitle = FALSE,
  sample.size.label = FALSE,
  data.label = "counts",
  legend.title = "Risk of violence",
  legend.position = "right",
  title = "Risk of violence by sex",
  palette = "Set1"
)

PlotXTabs2(
  data = RK_violence,
  y = ScoreText,
  x = Sex_Code_Text,
  xlab = "Sex",
  ylab = NULL,
  results.subtitle = FALSE,
  legend.title = "Risk of violence",
  legend.position = "right",
  title = "Risk of violence by sex",
  palette = "Set1"
)
```

We observe here that the majority sex of individuals in the compas dataset are men (78%). Despite this, the proportion of dangerous individuals is globally identical regardless of gender. We can simply note that 6% more men are at medium risk and at high risk.
